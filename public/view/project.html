<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>所有项目</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .project-card {
            margin-bottom: 1rem;
            cursor: pointer;
        }
        .project-details {
            display: block; /* 默认展开 */
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <h2 class="mb-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <a href="../dash.html" class="text-decoration-none text-dark me-2">
                            <i class="bi bi-arrow-left"></i>
                        </a>
                        所有项目
                        <button class="btn btn-primary ms-auto" onclick="window.location.href='../create/project.html'">
                            <i class="bi bi-plus-lg"></i> 新建项目
                        </button>
                    </div>
                </h2>
                <div id="projectsContainer">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/bootstrap.bundle.min.js"></script>
    <script>
        // 从 cookie 中获取 session
        const getSessionFromCookie = () => {
            const cookies = document.cookie.split('; ');
            for (const cookie of cookies) {
                const [name, value] = cookie.split('=');
                if (name === 'session') {
                    return decodeURIComponent(value);
                }
            }
            return null;
        };

        // 获取项目列表
        async function fetchProjects() {
            try {
                const response = await fetch('/api/getProjects', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'session': getSessionFromCookie()
                    }
                });
                
                if (response.status === 401) {
                    alert('未授权，请重新登录');
                    window.location.href = '/login.html';
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    renderProjects(data.projects);
                } else {
                    alert(data.message || '加载项目失败');
                }
            } catch (error) {
                console.error('Error fetching projects:', error);
                alert('加载项目失败，请重试');
            }
        }

        // 渲染项目列表
        function renderProjects(projects) {
            const container = document.getElementById('projectsContainer');
            
            if (projects.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <p>暂无项目</p>
                        <button class="btn btn-primary" onclick="window.location.href='../create/project.html'">
                            <i class="bi bi-plus-lg"></i> 创建第一个项目
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            projects.forEach(project => {
                const card = document.createElement('div');
                card.className = 'card project-card';
                card.innerHTML = `
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="me-3" style="width: 20px; height: 20px; background-color: ${project.color}; border-radius: 4px;"></div>
                            <h5>${project.name}</h5>
                        </div>
                        <div>
                            <span class="badge bg-secondary">#${project.id}</span>
                        </div>
                    </div>
                    <div class="card-body project-details">
                        <p>${project.description || '无描述'}</p>
                    </div>
                `;
                container.appendChild(card);
                
                // 添加卡片点击事件，跳转到详情页面
                card.addEventListener('click', () => {
                    window.location.href = `project_detail.html?id=${project.id}`;
                });
            });
        }

        // 页面加载完成后获取项目列表
        document.addEventListener('DOMContentLoaded', () => {
            const session = getSessionFromCookie();
            if (!session) {
                alert('未授权，请重新登录');
                window.location.href = '/login.html';
                return;
            }
            
            fetchProjects();
        });
    </script>
</body>
</html>