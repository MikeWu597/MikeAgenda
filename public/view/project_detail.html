<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>项目详情</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .record-item {
            border-left: 3px solid #007bff;
        }
        
        /* 日历样式 */
        .months-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }
        
        .month-card {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            background-color: #fff;
            width: 220px; /* 调小宽度 */
        }
        
        .month-header {
            background-color: #cce5ff; /* 浅蓝色 */
            color: #004085;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            border-radius: 0.375rem 0.375rem 0 0;
            font-size: 0.9rem;
        }
        
        .month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            padding: 5px;
        }
        
        .weekday-label {
            text-align: center;
            font-weight: bold;
            font-size: 0.6rem;
            padding: 3px;
        }
        
        .calendar-day {
            min-height: 24px;
            padding: 1px;
            text-align: center;
            border-radius: 0.25rem;
            font-size: 0.6rem;
            cursor: pointer;
            position: relative;
        }
        
        .calendar-day.empty {
            background-color: #f8f9fa;
        }
        
        .calendar-day.no-activity {
            background-color: #e9ecef;
        }
        
        .calendar-day.activity-level-0 {
            background-color: #cce5ff; /* 最浅的蓝色 */
        }
        
        .calendar-day.activity-level-1 {
            background-color: #99ccff;
        }
        
        .calendar-day.activity-level-2 {
            background-color: #66b2ff;
        }
        
        .calendar-day.activity-level-3 {
            background-color: #3399ff;
        }
        
        .calendar-day.activity-level-4 {
            background-color: #007bff; /* 默认蓝色 */
        }
        
        .calendar-day.activity-level-5 {
            background-color: #0066cc;
        }
        
        .calendar-day.activity-level-6 {
            background-color: #0052a3;
        }
        
        .calendar-day.activity-level-7 {
            background-color: #003d7a;
        }
        
        .calendar-day.future-day {
            background-color: #f8f9fa;
            color: #adb5bd;
        }
        
        .calendar-day:hover {
            opacity: 0.8;
        }
        
        .day-number {
            font-weight: bold;
        }
        
        /* popover样式调整 */
        .popover {
            max-width: 200px;
            font-size: 0.8rem;
        }
        
        .popover-body {
            padding: 0.5rem;
        }
        
        .popover-header {
            padding: 0.5rem;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <h2 class="mb-4">
                    <a href="project.html" class="text-decoration-none text-dark me-2">
                        <i class="bi bi-arrow-left"></i>
                    </a>
                    <span id="projectTitle">项目详情</span>
                </h2>
                
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div id="projectColor" class="me-3" style="width: 20px; height: 20px; background-color: #007bff; border-radius: 4px;"></div>
                            <h5 id="projectName">项目名称</h5>
                        </div>
                        <span class="badge bg-secondary" id="projectId">#</span>
                    </div>
                    <div class="card-body">
                        <p id="projectDescription">项目描述</p>
                        <div class="d-flex justify-content-end gap-2">
                            <button class="btn btn-danger" id="deleteProject">
                                删除项目
                            </button>
                            <button class="btn btn-primary" id="participateBtn">
                                参与项目
                            </button>
                            <button class="btn btn-secondary" id="editBtn">
                                编辑项目
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>参与记录日历</h4>
                    <button class="btn btn-sm btn-outline-primary" id="refreshRecords">
                        <i class="bi bi-arrow-repeat"></i> 刷新
                    </button>
                </div>
                
                <div id="recordsContainer">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑项目的模态框 -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">编辑项目</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="editProjectId">
                        <div class="mb-3">
                            <label for="editName" class="form-label">项目名称</label>
                            <input type="text" class="form-control" id="editName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editDescription" class="form-label">项目描述</label>
                            <textarea class="form-control" id="editDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editColor" class="form-label">项目颜色</label>
                            <input type="color" class="form-control" id="editColor">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="deleteProject">删除</button>
                    <button type="button" class="btn btn-primary" id="saveEdit">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/bootstrap.bundle.min.js"></script>
    <script>
        // 启用Bootstrap popover
        document.addEventListener('DOMContentLoaded', function() {
            // 不在这里初始化popover，而是在渲染记录时初始化
        });
        
        // 从 URL 获取项目 ID
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('id');

        // 从 cookie 中获取 session
        const getSessionFromCookie = () => {
            const cookies = document.cookie.split('; ');
            for (const cookie of cookies) {
                const [name, value] = cookie.split('=');
                if (name === 'session') {
                    return decodeURIComponent(value);
                }
            }
            return null;
        };

        // 获取项目详情
        async function fetchProject() {
            if (!projectId) {
                alert('无效的项目 ID');
                window.location.href = 'project.html';
                return;
            }

            try {
                const response = await fetch(`/api/getProject/${projectId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'session': getSessionFromCookie()
                    }
                });
                
                if (response.status === 401) {
                    alert('未授权，请重新登录');
                    window.location.href = '/login.html';
                    return;
                }
                
                if (response.status === 404) {
                    alert('项目未找到');
                    window.location.href = 'project.html';
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    renderProject(data.project);
                } else {
                    alert(data.message || '加载项目失败');
                }
            } catch (error) {
                console.error('Error fetching project:', error);
                alert('加载项目失败，请重试');
            }
        }

        // 渲染项目详情
        function renderProject(project) {
            document.getElementById('projectTitle').textContent = project.name;
            document.getElementById('projectName').textContent = project.name;
            document.getElementById('projectId').textContent = '#' + project.id;
            document.getElementById('projectDescription').textContent = project.description || '无描述';
            document.getElementById('projectColor').style.backgroundColor = project.color || '#007bff';
            
            // 设置编辑模态框的初始值
            document.getElementById('editProjectId').value = project.id;
            document.getElementById('editName').value = project.name;
            document.getElementById('editDescription').value = project.description || '';
            document.getElementById('editColor').value = project.color || '#007bff';
        }

        // 获取项目参与记录
        async function fetchProjectRecords() {
            try {
                const response = await fetch(`/api/getProjectRecords/${projectId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'session': getSessionFromCookie()
                    }
                });
                
                if (response.status === 401) {
                    alert('未授权，请重新登录');
                    window.location.href = '/login.html';
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    renderRecords(data.records);
                } else {
                    alert(data.message || '加载参与记录失败');
                }
            } catch (error) {
                console.error('Error fetching project records:', error);
                alert('加载参与记录失败，请重试');
            }
        }

        // 渲染参与记录
        function renderRecords(records) {
            const container = document.getElementById('recordsContainer');
            
            if (records.length === 0) {
                container.innerHTML = '<p class="text-muted">暂无参与记录</p>';
                return;
            }
            
            // 按日期分组记录 (只使用日期部分，不包括时间)
            const recordsByDate = {};
            let firstRecordDate = null;
            let lastRecordDate = null;
            
            records.forEach(record => {
                // 从完整时间戳中提取日期部分 YYYY-MM-DD
                const date = record.timestamp.split(' ')[0];
                if (!recordsByDate[date]) {
                    recordsByDate[date] = [];
                }
                recordsByDate[date].push(record);
                
                // 更新最早和最晚记录日期
                if (!firstRecordDate || date < firstRecordDate) {
                    firstRecordDate = date;
                }
                if (!lastRecordDate || date > lastRecordDate) {
                    lastRecordDate = date;
                }
            });
            
            // 确定显示月份范围（从首次记录月份开始，显示到当前月份，最多3个月）
            const today = new Date();
            let startDate;
            
            if (firstRecordDate) {
                const firstDate = new Date(firstRecordDate);
                const threeMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 2, 1);
                if (firstDate < threeMonthsAgo) {
                    startDate = threeMonthsAgo;
                } else {
                    startDate = new Date(firstDate.getFullYear(), firstDate.getMonth(), 1);
                }
            } else {
                // 如果没有记录，从当前月份开始
                startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            }
            
            // 创建月份日历
            const monthsContainer = document.createElement('div');
            monthsContainer.className = 'months-container';
            
            // 生成从起始月份到当前月份的日历（最多3个月）
            let currentDate = new Date(startDate);
            let monthCount = 0;
            
            while (currentDate <= today && monthCount < 3) {
                const monthCard = createMonthCard(currentDate, recordsByDate);
                monthsContainer.appendChild(monthCard);
                
                // 移动到下一个月
                currentDate.setMonth(currentDate.getMonth() + 1);
                monthCount++;
            }
            
            container.innerHTML = '';
            container.appendChild(monthsContainer);
            
            // 销毁现有的popover实例
            if (window.projectPopovers) {
                window.projectPopovers.forEach(popover => popover.dispose());
            }
            
            // 初始化popover
            const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
            window.projectPopovers = popoverTriggerList.map(function (popoverTriggerEl) {
                return new bootstrap.Popover(popoverTriggerEl, {
                    html: true,
                    trigger: 'hover',
                    placement: 'top',
                    container: 'body'
                });
            });
        }
        
        // 创建月份卡片
        function createMonthCard(date, recordsByDate) {
            const monthCard = document.createElement('div');
            monthCard.className = 'month-card';
            
            // 月份标题
            const monthHeader = document.createElement('div');
            monthHeader.className = 'month-header';
            monthHeader.textContent = `${date.getFullYear()}年${date.getMonth() + 1}月`;
            monthCard.appendChild(monthHeader);
            
            // 创建日历网格
            const monthGrid = document.createElement('div');
            monthGrid.className = 'month-grid';
            
            // 星期标题
            const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
            weekdays.forEach(day => {
                const weekdayLabel = document.createElement('div');
                weekdayLabel.className = 'weekday-label';
                weekdayLabel.textContent = day;
                monthGrid.appendChild(weekdayLabel);
            });
            
            // 获取该月第一天和最后一天
            const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
            const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);
            
            // 填充月初的空白天
            const firstDayOfWeek = firstDay.getDay();
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                monthGrid.appendChild(emptyDay);
            }
            
            // 填充该月的日期
            const today = new Date();
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const currentDate = new Date(date.getFullYear(), date.getMonth(), day);
                // 使用更准确的方法生成日期字符串 (YYYY-MM-DD)
                const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayElement = document.createElement('div');
                
                // 判断是否是未来日期
                if (currentDate > today) {
                    dayElement.className = 'calendar-day future-day';
                } else {
                    // 检查是否有记录
                    if (recordsByDate[dateStr]) {
                        const recordCount = recordsByDate[dateStr].length;
                        // 根据参与次数确定颜色深浅 (最多7个级别)
                        const level = Math.min(recordCount, 7);
                        dayElement.className = `calendar-day activity-level-${level}`;
                        dayElement.setAttribute('data-bs-toggle', 'popover');
                        dayElement.setAttribute('data-bs-placement', 'top');
                        dayElement.setAttribute('data-bs-trigger', 'hover');
                        dayElement.setAttribute('data-bs-html', 'true');
                        dayElement.setAttribute('data-bs-title', dateStr);
                        
                        // 构建popover内容
                        let content = `<strong>${recordCount} 条参与记录:</strong><br>`;
                        recordsByDate[dateStr].forEach((record, index) => {
                            const time = new Date(record.timestamp).toLocaleTimeString('zh-CN', { 
                                hour: '2-digit', 
                                minute: '2-digit',
                                second: '2-digit'
                            });
                            content += `<small>${index + 1}. ${time}</small><br>`;
                        });
                        
                        dayElement.setAttribute('data-bs-content', content);
                    } else {
                        dayElement.className = 'calendar-day no-activity';
                        dayElement.setAttribute('data-bs-toggle', 'popover');
                        dayElement.setAttribute('data-bs-placement', 'top');
                        dayElement.setAttribute('data-bs-trigger', 'hover');
                        dayElement.setAttribute('data-bs-title', dateStr);
                        dayElement.setAttribute('data-bs-content', '无参与记录');
                    }
                }
                
                // 添加日期数字
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayElement.appendChild(dayNumber);
                
                // 不再添加记录数量，而是通过颜色深浅表示
                
                monthGrid.appendChild(dayElement);
            }
            
            monthCard.appendChild(monthGrid);
            return monthCard;
        }

        // 参与项目
        async function participateInProject() {
            try {
                const session = getSessionFromCookie();
                const response = await fetch('/api/participateInProject', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ projectId, session })
                });
                
                if (response.status === 401) {
                    alert('未授权，请重新登录');
                    window.location.href = '/login.html';
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    alert('已记录参与项目');
                    fetchProjectRecords(); // 刷新记录
                } else {
                    alert(data.message || '参与项目失败');
                }
            } catch (error) {
                console.error('Error participating in project:', error);
                alert('参与项目失败，请重试');
            }
        }

        // 删除项目
        async function deleteProject() {
            if (!confirm('确定要删除这个项目吗？')) {
                return;
            }
            
            try {
                const session = getSessionFromCookie();
                const response = await fetch(`/api/deleteProject/${projectId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session })
                });
                
                if (response.status === 401) {
                    alert('未授权，请重新登录');
                    window.location.href = '/login.html';
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    alert('项目已删除');
                    window.location.href = 'project.html';
                } else {
                    alert(data.message || '删除项目失败');
                }
            } catch (error) {
                console.error('Error deleting project:', error);
                alert('删除项目失败，请重试');
            }
        }

        // 保存编辑
        async function saveEdit() {
            const name = document.getElementById('editName').value;
            const description = document.getElementById('editDescription').value;
            const color = document.getElementById('editColor').value;
            
            try {
                const session = getSessionFromCookie();
                const response = await fetch(`/api/updateProject/${projectId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description, color, session })
                });
                
                if (response.status === 401) {
                    alert('未授权，请重新登录');
                    window.location.href = '/login.html';
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    alert('项目已更新');
                    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                    fetchProject(); // 重新加载项目信息
                } else {
                    alert(data.message || '更新项目失败');
                }
            } catch (error) {
                console.error('Error updating project:', error);
                alert('更新项目失败，请重试');
            }
        }

        // 页面加载完成后获取项目信息和记录
        document.addEventListener('DOMContentLoaded', () => {
            const session = getSessionFromCookie();
            if (!session) {
                alert('未授权，请重新登录');
                window.location.href = '/login.html';
                return;
            }
            
            if (!projectId) {
                alert('无效的项目 ID');
                window.location.href = 'project.html';
                return;
            }
            
            fetchProject();
            fetchProjectRecords();
        });

        // 绑定事件
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('participateBtn').addEventListener('click', participateInProject);
            document.getElementById('editBtn').addEventListener('click', () => {
                const editModal = new bootstrap.Modal(document.getElementById('editModal'));
                editModal.show();
            });
            document.getElementById('deleteProject').addEventListener('click', deleteProject);
            document.getElementById('saveEdit').addEventListener('click', saveEdit);
            document.getElementById('refreshRecords').addEventListener('click', fetchProjectRecords);
        });
    </script>
</body>
</html>